{% extends 'predictor/base.html' %}

{% block title %}Prediction Result{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card result-card">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <h2 class="card-title mb-3">Prediction Results</h2>
                    <p class="text-muted">{{ record.disease|title }} Analysis</p>
                </div>

                <div class="result-summary text-center mb-5">
                    <div class="prediction-badge mb-3">
                        <span class="badge bg-{{ color_class }} p-3 fs-4">
                            {{ record.prediction_label }}
                        </span>
                    </div>
                    <h3 class="mb-2">Confidence: {{ probability_percent }}%</h3>
                    <p class="text-muted">Prediction made on {{ record.created_at|date:"F d, Y \a\t H:i" }}</p>
                </div>

                {% if record.probabilities %}
                <div class="mb-5">
                    <h5 class="mb-3">Probability Distribution</h5>
                    <div class="row">
                        <div class="col-md-6 mx-auto">
                            <canvas id="probabilityChart"></canvas>
                        </div>
                    </div>
                    <div class="mt-3">
                        {% for label, prob in record.probabilities.items %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>{{ label }}</span>
                            <div class="progress flex-grow-1 mx-3" style="height: 25px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ prob|floatformat:4|slice:"2:" }}00%"
                                     aria-valuenow="{{ prob|floatformat:4|slice:"2:" }}00" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ prob|floatformat:4|slice:"2:" }}00%
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div class="mb-4">
                    <h5 class="mb-3">Input Summary</h5>
                    <div class="input-summary card bg-light">
                        <div class="card-body">
                            <div class="row">
                                {% for key, value in record.inputs.items %}
                                <div class="col-md-6 mb-2">
                                    <strong>{{ key|title }}:</strong> 
                                    {% if value|floatformat:2 %}
                                        {{ value|floatformat:2 }}
                                    {% else %}
                                        {{ value }}
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <a href="{% url 'report' record.id %}" class="btn btn-success btn-lg">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Download PDF Report
                    </a>
                    <a href="{% url record.disease %}" class="btn btn-outline-primary">
                        New {{ record.disease|title }} Prediction
                    </a>
                    <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                        Back to Home
                    </a>
                </div>
            </div>
        </div>

        <div class="alert alert-warning mt-4" role="alert">
            <strong>Medical Disclaimer:</strong> This prediction is generated by a machine learning model 
            and should not replace professional medical diagnosis. Always consult with qualified healthcare 
            providers for medical advice.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Chart.js visualization for probability distribution
document.addEventListener('DOMContentLoaded', function() {
    const probabilities = {{ record.probabilities|safe }};
    
    if (probabilities && Object.keys(probabilities).length > 0) {
        const ctx = document.getElementById('probabilityChart');
        if (ctx) {
            const labels = Object.keys(probabilities);
            const data = Object.values(probabilities);
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(58, 28, 113, 0.8)',
                            'rgba(215, 109, 119, 0.8)',
                            'rgba(255, 175, 123, 0.8)'
                        ],
                        borderColor: [
                            'rgba(58, 28, 113, 1)',
                            'rgba(215, 109, 119, 1)',
                            'rgba(255, 175, 123, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + (context.parsed * 100).toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}
