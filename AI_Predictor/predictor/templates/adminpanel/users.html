{% extends "adminpanel/dashboard.html" %}
{% block extra_css %}
<style>
.user-table { background: white; border-radius: 15px; padding: 25px; }
.btn-action { margin: 0 5px; }
.modal-content { border-radius: 15px; }
</style>
{% endblock %}
{% block main_content %}
<div class="top-bar">
    <h2>User Management</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
        <i class="fas fa-user-plus"></i> Add User
    </button>
</div>

{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }} alert-dismissible">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}

<div class="user-table">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>ID</th><th>Username</th><th>Email</th><th>Role</th>
                <th>Predictions</th><th>Joined</th><th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td><i class="fas fa-user"></i> {{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td>
                    {% for group in user.groups.all %}
                    <span class="badge bg-primary">{{ group.name }}</span>
                    {% empty %}
                    <span class="badge bg-secondary">No Role</span>
                    {% endfor %}
                </td>
                <td>{{ user.prediction_count }}</td>
                <td>{{ user.date_joined|date:"Y-m-d" }}</td>
                <td>
                    {% if user != request.user %}
                    <button class="btn btn-sm btn-warning btn-action" onclick="changeRole({{ user.id }}, '{{ user.username }}')">
                        <i class="fas fa-user-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger btn-action" onclick="deleteUser({{ user.id }}, '{{ user.username }}')">
                        <i class="fas fa-trash"></i>
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5><i class="fas fa-user-plus"></i> Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_user">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" name="username" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" name="password" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select name="role" class="form-select">
                            <option value="User">User</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function deleteUser(id, username) {
    if(confirm(`Delete user "${username}"?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.innerHTML = `
            {% csrf_token %}
            <input name="action" value="delete_user">
            <input name="user_id" value="${id}">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}

function changeRole(id, username) {
    const role = prompt(`New role for ${username}? (Admin/User)`);
    if(role) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.innerHTML = `
            {% csrf_token %}
            <input name="action" value="change_role">
            <input name="user_id" value="${id}">
            <input name="new_role" value="${role}">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
